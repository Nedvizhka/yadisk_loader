2023-12-18 15:00:49,796 [INFO    ] Скрипт запущен: 2023-12-18 15:00:49.796621
2023-12-18 15:00:49,881 [INFO    ] Connected (version 2.0, client OpenSSH_7.4p1)
2023-12-18 15:00:49,952 [INFO    ] Authentication (publickey) failed.
2023-12-18 15:00:49,967 [INFO    ] Connected (version 2.0, client OpenSSH_7.4p1)
2023-12-18 15:00:50,059 [INFO    ] Authentication (password) successful!
2023-12-18 15:00:50,061 [INFO    ] connected to host 92.53.64.66 base preprod_nedvizhka_db
2023-12-18 15:00:50,280 [INFO    ] yandex token valid
2023-12-18 15:00:53,608 [INFO    ] Успешно загружено 1 файлов с личного диска: ['17-12-23 (без дублей).csv'] для avito
2023-12-18 15:00:54,030 [INFO    ] yandex token valid
2023-12-18 15:01:02,086 [INFO    ] Успешно загружено 3 файлов с личного диска: ['циан 16-12-23 (без дублей) new.csv', 'циан 16-12-23 (без дублей).csv', 'циан 17-12-23 (без дублей).csv'] для cian
2023-12-18 15:01:02,086 [INFO    ] ready to process files ['17-12-23 (без дублей).csv'], ['циан 16-12-23 (без дублей) new.csv', 'циан 16-12-23 (без дублей).csv', 'циан 17-12-23 (без дублей).csv']
2023-12-18 15:01:08,797 [INFO    ] обновлен status_new в таблице realty
2023-12-18 15:01:18,438 [INFO    ] обновлен status_new в таблице prices
2023-12-18 15:01:18,440 [INFO    ] обработка файла циан 16-12-23 (без дублей) new.csv для cian
2023-12-18 15:01:19,735 [INFO    ] обработка district_id:
2023-12-18 15:01:19,737 [INFO    ] districts_update:   0%|          | 0/121998 [00:00<?, ?it/s]
2023-12-18 15:01:34,738 [INFO    ] districts_update:  11%|#1        | 14008/121998 [00:15<01:55, 933.84it/s]
2023-12-18 15:01:47,066 [INFO    ] districts_update:  21%|##        | 25487/121998 [00:27<01:43, 933.84it/s]
2023-12-18 15:01:49,739 [INFO    ] districts_update:  23%|##3       | 28334/121998 [00:30<01:38, 946.31it/s]
2023-12-18 15:02:04,739 [INFO    ] districts_update:  36%|###6      | 44210/121998 [00:45<01:17, 997.49it/s]
2023-12-18 15:02:17,083 [INFO    ] districts_update:  46%|####6     | 56152/121998 [00:57<01:06, 997.49it/s]
2023-12-18 15:02:19,739 [INFO    ] districts_update:  48%|####8     | 58644/121998 [01:00<01:04, 983.58it/s]
2023-12-18 15:02:34,739 [INFO    ] districts_update:  60%|######    | 73241/121998 [01:15<00:49, 979.81it/s]
2023-12-18 15:02:47,097 [INFO    ] districts_update:  70%|#######   | 85550/121998 [01:27<00:37, 979.81it/s]
2023-12-18 15:02:49,739 [INFO    ] districts_update:  72%|#######2  | 87895/121998 [01:30<00:34, 978.83it/s]
2023-12-18 15:03:04,739 [INFO    ] districts_update:  84%|########4 | 102566/121998 [01:45<00:19, 978.57it/s]
2023-12-18 15:03:17,116 [INFO    ] districts_update:  94%|#########3| 114462/121998 [01:57<00:07, 978.57it/s]
2023-12-18 15:03:19,740 [INFO    ] districts_update:  96%|#########6| 117231/121998 [02:00<00:04, 978.26it/s]
2023-12-18 15:03:24,529 [INFO    ] districts_update: 100%|##########| 121998/121998 [02:04<00:00, 977.61it/s]
2023-12-18 15:03:24,530 [INFO    ] 
2023-12-18 15:03:24,538 [INFO    ] district add from realty
2023-12-18 15:03:26,730 [INFO    ] Успешно обработан файл циан 16-12-23 (без дублей) new.csv для realty
2023-12-18 15:03:26,738 [INFO    ] Выгрузка в таблицу realty обработанного файла из cian: циан 16-12-23 (без дублей) new.csv
2023-12-18 15:03:27,189 [INFO    ] Временная таблица создана
2023-12-18 15:03:38,620 [INFO    ] Загрузка новых объявлений в таблицу
2023-12-18 15:03:38,861 [INFO    ] 118962 существующих и 3036 новых объявлений
2023-12-18 15:03:38,908 [INFO    ] temp таблица очищена, загружаются данные
2023-12-18 15:04:51,663 [INFO    ] обновлена таблица realty
2023-12-18 15:05:18,526 [INFO    ] обновлены районы в таблице realty
2023-12-18 15:05:34,561 [INFO    ] Обновление существующих данных realty завершено
2023-12-18 15:06:10,209 [INFO    ] из новых объяв найдено по адресу 669, запрос в ddt для 680 уник. адресов из 2367
2023-12-18 15:06:10,209 [INFO    ] обновление районов для найденных в realty по адресу новых объявлений:
2023-12-18 15:06:10,382 [INFO    ] обнаружено 46 районов для 53 новых объявлений, найденных по адресу из 70
2023-12-18 15:06:10,402 [INFO    ] 27 районов осталось незаполнено
2023-12-18 15:06:10,403 [INFO    ] переход к обновлению оставшихся (не найденных по адресу) 2367 новых объявлений (680 адресов) для cian
2023-12-18 15:06:10,425 [INFO    ] загрузка данных dadata из /var/www/yadisk_loader/saved_data_csv/cian_dadata_request.csv
2023-12-18 15:06:11,231 [INFO    ] удалось загрузить исторические данные dadata
2023-12-18 15:06:13,238 [INFO    ] количество запросов к dadata составит: 680
2023-12-18 15:06:13,240 [INFO    ] 0%|          | 0/173 [00:00<?, ?it/s]
2023-12-18 15:06:15,072 [INFO    ] 680it [00:01, 371.21it/s]
2023-12-18 15:06:15,072 [INFO    ] 
2023-12-18 15:06:15,072 [INFO    ] dadata con closed succesfully
2023-12-18 15:06:15,073 [INFO    ] обращение к DDT по 516/680 адресам из cian заняло 0:00:04.669883
2023-12-18 15:06:15,091 [INFO    ] обращение к DDT выполнено для 1108/2367 новых объявлений, найден fias для 777
2023-12-18 15:07:22,475 [INFO    ] уникальных троек по h_fias_id, ad_id, d_id, в таблице с районами и houses_jkh_ddt/id: 1108
2023-12-18 15:07:22,482 [INFO    ] выгрузка данных в таблицу realty
2023-12-18 15:07:23,311 [INFO    ] Добавлено районов к объявлениям realty: 1 - было 1413 стало 1414
2023-12-18 15:07:23,311 [INFO    ] Есть несовпадения районов c jkh, обновление районов в jkh для 11 записей
2023-12-18 15:07:29,679 [INFO    ] Временная таблица temp_jkh_houses создана
2023-12-18 15:07:33,093 [INFO    ] Обновление данных jkh_houses завершено
2023-12-18 15:07:34,485 [INFO    ] все новые объявления добавлены
2023-12-18 15:07:36,037 [INFO    ] Успешно обработан файл циан 16-12-23 (без дублей) new.csv для prices
2023-12-18 15:07:36,037 [INFO    ] Выгрузка в таблицу prices обработанного файла из cian: циан 16-12-23 (без дублей) new.csv
2023-12-18 15:07:49,408 [INFO    ] данные cian загружены успешно
2023-12-18 15:07:49,409 [INFO    ] обработка файла циан 16-12-23 (без дублей).csv для cian
2023-12-18 15:07:49,436 [ERROR   ] Traceback (most recent call last):
  File "/var/www/yadisk_loader/main_utils.py", line 971, in process_realty
    saved_file = pd.read_csv(saved_files[f_ind], delimiter=',', encoding='utf8')
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/util/_decorators.py", line 211, in wrapper
    return func(*args, **kwargs)
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/util/_decorators.py", line 331, in wrapper
    return func(*args, **kwargs)
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/io/parsers/readers.py", line 950, in read_csv
    return _read(filepath_or_buffer, kwds)
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/io/parsers/readers.py", line 611, in _read
    return parser.read(nrows)
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/io/parsers/readers.py", line 1778, in read
    ) = self._engine.read(  # type: ignore[attr-defined]
  File "/var/www/yadisk_loader/yadisk_venv/lib/python3.9/site-packages/pandas/io/parsers/c_parser_wrapper.py", line 230, in read
    chunks = self._reader.read_low_memory(nrows)
  File "pandas/_libs/parsers.pyx", line 808, in pandas._libs.parsers.TextReader.read_low_memory
  File "pandas/_libs/parsers.pyx", line 866, in pandas._libs.parsers.TextReader._read_rows
  File "pandas/_libs/parsers.pyx", line 852, in pandas._libs.parsers.TextReader._tokenize_rows
  File "pandas/_libs/parsers.pyx", line 1973, in pandas._libs.parsers.raise_parser_error
pandas.errors.ParserError: Error tokenizing data. C error: Expected 6 fields in line 164, saw 7


2023-12-18 15:07:49,441 [ERROR   ] Файл циан 16-12-23 (без дублей).csv не удалось обнаружить для realty
2023-12-18 15:07:49,465 [ERROR   ] Ошибка при обработке файлов из CIAN циан 16-12-23 (без дублей).csv. Перезапуск скрипта...
2023-12-18 15:07:49,511 [INFO    ] обработка файла 17-12-23 (без дублей).csv для авито
2023-12-18 15:08:37,018 [INFO    ] Успешно обработан файл 17-12-23 (без дублей).csv для realty
2023-12-18 15:08:37,081 [INFO    ] Выгрузка в таблицу realty обработанного файла из авито: 17-12-23 (без дублей).csv
2023-12-18 15:08:37,224 [INFO    ] Временная таблица очищена
2023-12-18 15:08:42,380 [INFO    ] Загрузка новых объявлений в таблицу
2023-12-18 15:08:42,582 [INFO    ] 183491 существующих и 1262 новых объявлений
2023-12-18 15:08:42,627 [INFO    ] temp таблица очищена, загружаются данные
2023-12-18 15:09:57,757 [INFO    ] обновлена таблица realty
2023-12-18 15:10:00,359 [INFO    ] обновлены районы в таблице realty
2023-12-18 15:10:13,817 [INFO    ] Обновление существующих данных realty завершено
2023-12-18 15:10:48,039 [INFO    ] из новых объяв найдено по адресу 407, запрос в ddt для 399 уник. адресов из 855
2023-12-18 15:10:48,039 [INFO    ] обновление районов для найденных в realty по адресу новых объявлений:
2023-12-18 15:10:48,298 [INFO    ] обнаружено 184 районов для 294 новых объявлений, найденных по адресу из 407
2023-12-18 15:10:48,304 [INFO    ] 112 районов осталось незаполнено
2023-12-18 15:10:48,304 [INFO    ] переход к обновлению оставшихся (не найденных по адресу) 855 новых объявлений (399 адресов) для avito
2023-12-18 15:10:48,327 [INFO    ] загрузка данных dadata из /var/www/yadisk_loader/saved_data_csv/avito_dadata_request.csv
2023-12-18 15:10:49,752 [INFO    ] удалось загрузить исторические данные dadata
2023-12-18 15:10:51,762 [INFO    ] количество запросов к dadata составит: 399
2023-12-18 15:10:51,768 [INFO    ] 0%|          | 0/29 [00:00<?, ?it/s]
2023-12-18 15:10:53,208 [INFO    ] 399it [00:01, 277.15it/s]
2023-12-18 15:10:53,208 [INFO    ] 
2023-12-18 15:10:53,208 [INFO    ] dadata con closed succesfully
2023-12-18 15:10:53,209 [INFO    ] обращение к DDT по 378/399 адресам из avito заняло 0:00:04.904727
2023-12-18 15:10:53,219 [INFO    ] обращение к DDT выполнено для 727/855 новых объявлений, найден fias для 434
2023-12-18 15:12:10,481 [INFO    ] уникальных троек по h_fias_id, ad_id, d_id, в таблице с районами и houses_jkh_ddt/id: 727
2023-12-18 15:12:10,488 [INFO    ] выгрузка данных в таблицу realty
2023-12-18 15:12:10,784 [INFO    ] Добавлено районов к объявлениям realty: 90 - было 0 стало 90
2023-12-18 15:12:10,785 [INFO    ] Есть несовпадения районов c jkh, обновление районов в jkh для 0 записей
2023-12-18 15:12:13,883 [INFO    ] Временная таблица temp_jkh_houses очищена
2023-12-18 15:12:17,269 [INFO    ] Обновление данных jkh_houses завершено
2023-12-18 15:12:18,130 [INFO    ] все новые объявления добавлены
2023-12-18 15:12:20,407 [INFO    ] Успешно обработан файл 17-12-23 (без дублей).csv для prices
2023-12-18 15:12:20,407 [INFO    ] Выгрузка в таблицу prices обработанного файла из авито: 17-12-23 (без дублей).csv
2023-12-18 15:12:40,298 [INFO    ] данные avito загружены успешно
2023-12-18 15:12:40,706 [INFO    ] Новые данные загружены по файлам ['17-12-23 (без дублей).csv'] из авито и ['циан 16-12-23 (без дублей) new.csv', 'циан 16-12-23 (без дублей).csv', 'циан 17-12-23 (без дублей).csv'] из циана за 0:11:50.909660
2023-12-18 15:12:40,813 [INFO    ] HTTP Request: GET https://dadata.ru/api/v2/profile/balance "HTTP/1.1 200 OK"
2023-12-18 15:12:40,818 [INFO    ] сохранение лог-файла
